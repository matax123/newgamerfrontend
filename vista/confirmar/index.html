<html>

<head>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link rel="stylesheet" href="../../styles/styles.css">
    <!-- <link rel="stylesheet" href="../../styles/mercadoPago.css"> -->
    <!-- <script src="../../js/beforeLoad.js"></script> -->
    <!-- <script src="../../js/common.js"></script> -->
</head>

<body>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"
        }
    </style>
    <div id="cardPaymentBrick_container"></div>
    <script>
        let orderId = window.location.search.split('=')[1];
        let transactionAmount = window.location.search.split('=')[2];
        console.log(transactionAmount)
        const mp = new MercadoPago('TEST-4eb59f4e-3eb9-4802-a4a9-02dac4b806db', {
            locale: 'es-CL'
        });
        const bricksBuilder = mp.bricks();
        const renderCardPaymentBrick = async (bricksBuilder) => {
            const settings = {
                initialization: {
                    amount: transactionAmount, // monto a ser pago. Debe ser un número entero.
                    payer: {
                        email: "",
                    },
                },
                customization: {
                    visual: {
                        style: {
                            customVariables: {
                                theme: 'default', // | 'dark' | 'bootstrap' | 'flat'
                            }
                        }
                    },
                    paymentMethods: {
                        maxInstallments: 1,
                    }
                },
                callbacks: {
                    onReady: () => {
                        // callback llamado cuando Brick esté listo
                    },
                    onSubmit: (cardFormData) => {
                        cardFormData.orderId = parseInt(orderId);
                        //  callback llamado cuando el usuario haga clic en el botón enviar los datos
                        //  ejemplo de envío de los datos recolectados por el Brick a su servidor
                        return new Promise((resolve, reject) => {
                            fetch(backendUrl + "/ConfirmOrder", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(cardFormData)
                            })
                                .then((response) => {
                                    // recibir el resultado del pago
                                    // resolve();
                                    if (response.status == 200) {
                                        resolve();
                                        window.location.href = "../gracias/index.html";
                                    } else {
                                        alert("Su pago fue rechazado. Por favor intente nuevamente.");
                                        reject();
                                    }
                                })
                                .catch((error) => {
                                    // tratar respuesta de error al intentar crear el pago
                                    reject();
                                })
                        });
                    },
                    onError: (error) => {
                        alert("Erro al intentar hacer el pago, por favor intente más tarde.");
                        // callback llamado para todos los casos de error de Brick
                    },
                },
            };
            window.cardPaymentBrickController = await bricksBuilder.create('cardPayment', 'cardPaymentBrick_container', settings);
        };
        renderCardPaymentBrick(bricksBuilder);
    </script>
</body>

</html>